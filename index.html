<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>🌍 Global Surface Temperature Anomaly</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
</head>
<body style="background-color:#111; margin:0; padding:0;">

<div id="tempMap" style="width:100%; height:100vh;"></div>

<script>
  // Load CSV using Plotly's built-in CSV loader
  Plotly.d3.csv("global_surface_temp_NOAA_grid_2005_2025.csv", function(err, rows) {
    if (err) {
      console.error("CSV load error:", err);
      return;
    }

    // Parse data
    const dates = rows.map(r => new Date(r.date));
    const lats = rows.map(r => parseFloat(r.lat));
    const lons = rows.map(r => parseFloat(r.lon));
    const tempAnomaly = rows.map(r => parseFloat(r.temp_anomaly_c));
    const monthStr = rows.map(r => {
      const d = new Date(r.date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    });

    // Unique frames
    const uniqueMonths = [...new Set(monthStr)];

    // Create frames for animation
    const frames = uniqueMonths.map(m => {
      const idx = monthStr.map((x, i) => (x === m ? i : -1)).filter(i => i >= 0);
      return {
        name: m,
        data: [{
          type: "scattergeo",
          mode: "markers",
          lat: idx.map(i => lats[i]),
          lon: idx.map(i => lons[i]),
          marker: {
            color: idx.map(i => tempAnomaly[i]),
            colorscale: "RdBu",
            cmin: -2.5,
            cmax: 2.5,
            size: 4,
            opacity: 0.85,
            colorbar: {
              title: "Temp Anomaly (°C)",
              tickvals: [-2, -1, 0, 1, 2]
            }
          },
          text: idx.map(i => `Lat: ${lats[i]}, Lon: ${lons[i]}, Anomaly: ${tempAnomaly[i]} °C`)
        }]
      };
    });

    // Initial trace (first month)
    const initIdx = monthStr.map((x, i) => (x === uniqueMonths[0] ? i : -1)).filter(i => i >= 0);
    const trace = {
      type: "scattergeo",
      mode: "markers",
      lat: initIdx.map(i => lats[i]),
      lon: initIdx.map(i => lons[i]),
      marker: {
        color: initIdx.map(i => tempAnomaly[i]),
        colorscale: "RdBu",
        cmin: -2.5,
        cmax: 2.5,
        size: 4,
        opacity: 0.85,
        colorbar: {
          title: "Temp Anomaly (°C)",
          tickvals: [-2, -1, 0, 1, 2]
        }
      }
    };

    // Layout
    const layout = {
      title: {
        text: "🌍 Global Surface Temperature Anomaly (NOAA) — 5° Grid (2005–2025)",
        font: {size: 18, color: "lightblue"}
      },
      geo: {
        projection: {type: "natural earth"},
        showland: true,
        landcolor: "rgba(40,40,40,0.9)",
        showcountries: true,
        countrycolor: "rgba(150,150,150,0.4)",
        showocean: true,
        oceancolor: "rgba(10,30,60,0.9)"
      },
      margin: {l: 0, r: 120, t: 60, b: 0},
      font: {family: "Arial", size: 12, color: "white"},
      updatemenus: [{
        type: "buttons",
        showactive: false,
        buttons: [
          {label: "Play", method: "animate", args: [null, {frame: {duration: 100, redraw: true}, fromcurrent: true}]},
          {label: "Pause", method: "animate", args: [[null], {mode: "immediate", frame: {duration: 0}, transition: {duration: 0}}]}
        ]
      }]
    };

    // Plot with animation
    Plotly.newPlot("tempMap", [trace], layout).then(() => {
      Plotly.addFrames("tempMap", frames);
    });
  });
</script>
</body>
</html>
